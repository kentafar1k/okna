# Система резервного копирования для Django-проекта

Эта система предназначена для автоматического создания резервных копий базы данных и медиа-файлов вашего проекта Django с хранением их на облачном хранилище Selectel.

## Возможности

- Автоматическое создание резервных копий базы данных (PostgreSQL, SQLite)
- Опциональное резервное копирование медиа-файлов
- Хранение только указанного количества последних резервных копий (по умолчанию 2)
- Автоматическое удаление старых копий
- Загрузка резервных копий на облачное хранилище Selectel
- Запуск по расписанию через cron

## Установка и настройка

### 1. Установка зависимостей

Установите необходимые пакеты Python:

```bash
pip install requests
```

### 2. Настройка параметров

Отредактируйте файл `backup_settings.py`, указав настройки вашего аккаунта Selectel и параметры резервного копирования:

```python
# Настройки Selectel
SELECTEL_CONTAINER = 'your_container_name'  # Имя контейнера на Selectel
SELECTEL_USERNAME = 'your_username'  # Имя пользователя Selectel
SELECTEL_PASSWORD = 'your_password'  # Пароль Selectel
SELECTEL_AUTH_URL = 'https://api.selcdn.ru/auth/v1.0'

# Максимальное количество резервных копий для хранения
MAX_BACKUPS = 2

# Включить резервное копирование медиа-файлов (True/False)
BACKUP_MEDIA = False

# Путь к директории с медиа-файлами (относительно корня проекта)
MEDIA_DIR = 'media'
```

### 3. Настройка cron-задания

Для автоматического запуска резервного копирования, сделайте скрипт `cron_setup.sh` исполняемым и запустите его:

```bash
chmod +x cron_setup.sh
./cron_setup.sh
```

Скрипт предложит выбрать время для ежедневного запуска резервного копирования.

### 4. Создание контейнера в Selectel

Перед использованием убедитесь, что у вас создан контейнер в облачном хранилище Selectel.

1. Войдите в панель управления Selectel
2. Перейдите в раздел "Облачное хранилище"
3. Создайте новый контейнер с именем, указанным в настройках (`SELECTEL_CONTAINER`)

## Ручной запуск

Для ручного создания резервной копии выполните:

```bash
python backup_manager.py
```

## Лог резервного копирования

Информация о процессе резервного копирования записывается в файл `backup.log` в корне проекта.

## Восстановление из резервной копии

### Восстановление базы данных PostgreSQL

```bash
# Разархивируем файл
gunzip -c backup_file.sql.gz > backup_file.sql

# Восстанавливаем базу данных
psql -U username -d database_name -f backup_file.sql
```

### Восстановление базы данных SQLite

```bash
# Разархивируем файл
gunzip -c backup_file.sql.gz > database.sqlite3
```

### Восстановление медиа-файлов

```bash
# Разархивируем файл
tar -xzf media_backup_file.tar.gz -C /path/to/project/
```

## Устранение неполадок

### Ошибка авторизации в Selectel

- Проверьте правильность учетных данных в файле `backup_settings.py`
- Убедитесь, что у вашего аккаунта есть доступ к облачному хранилищу

### Cron не запускает задание

- Проверьте статус службы cron: `systemctl status cron`
- Проверьте права доступа: `chmod +x backup_manager.py`
- Проверьте логи cron: `grep CRON /var/log/syslog` 